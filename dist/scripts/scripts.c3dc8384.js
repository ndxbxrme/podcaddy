"use strict";angular.module("podcaddyApp",["ngAnimate","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/allfeeds",{templateUrl:"views/allfeeds.html",controller:"AllfeedsCtrl"}).when("/myfeeds",{templateUrl:"views/myfeeds.html",controller:"MyfeedsCtrl"}).when("/:arg1?/:arg2?/:arg3?/:arg4",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).run(["$rootScope","PagePlayer","NavService","$route","$http",function(a,b,c,d,e){a.items=[],a.$on("$routeChangeSuccess",function(){if(d&&d.current){c.filters.feed="all",c.filters.playlist="none";for(var a=1;5>a;a++)c.parseArg(d.current.params["arg"+a]);"MainCtrl"===d.current.$$route.controller?(c.filters.page="/",b.changePage()):"AllfeedsCtrl"===d.current.$$route.controller?c.filters.page="/allfeeds":"MyfeedsCtrl"===d.current.$$route.controller&&(c.filters.page="/myfeeds")}}),e.post("/api")}]),soundManager.setup({flashVersion:9,preferFlash:!0,url:"swf/"}),angular.module("podcaddyApp").factory("authInterceptor",["$rootScope","$q","$window","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},response:function(c){return 401===c.status?(a.loggedIn=!1,d.path("/login")):a.loggedIn=!0,c||b.when(c)},responseError:function(c){return a.loggedIn=!1,401===c.status&&d.path("/login"),c||b.when(c)}}}]).config(["$httpProvider",function(a){a.interceptors.push("authInterceptor")}]),angular.module("podcaddyApp").controller("MainCtrl",["$rootScope","$http","Timer",function(a,b,c){a.cssPage="mainPage",c.start(),angular.isDefined(a.lazyLoad)&&a.lazyLoad.doScroll()}]),angular.module("podcaddyApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("podcaddyApp").controller("LoginCtrl",["$scope","$http","$window","$rootScope","$location","Timer",function(a,b,c,d,e,f){f.stop(),d.cssPage="loginPage",a.message="";var g=function(a){for(var b=0,c=0;c<a.length;c++){var d=a.charCodeAt(c);b=(b<<5)-b+d}return b};a.submit=function(){b.post("/authenticate",angular.extend(a.user,{password:g(a.user.password)})).success(function(a){d.loggedIn=!0,c.sessionStorage.token=a.token,e.path("/")}).error(function(b){d.loggedIn=!1,delete c.sessionStorage.token,a.message=b})},a.signup=function(){a.signingUp=!0,a.myForm.$valid&&b.post("/signup",angular.extend(a.user,{password:g(a.user.password)})).success(function(b){b.error?(d.loggedIn=!1,a.message=b.message,a.user.password=""):(d.loggedIn=!0,c.sessionStorage.token=b.token,e.path("/allfeeds"))}).error(function(b){d.loggedIn=!1,delete c.sessionStorage.token,a.message=b})}}]),angular.module("podcaddyApp").directive("ensureUnique",["$http",function(a){return{require:"ngModel",link:function(b,c,d,e){b.$watch(d.ngModel,function(b){b!==d.original&&b?a({method:"POST",url:"/check/"+d.ensureUnique,data:{field:b}}).success(function(a){e.$setValidity("unique",!a.isUnique)}).error(function(){e.$setValidity("unique",!1)}):e.$setValidity("unique",!0)})}}}]),angular.module("podcaddyApp").controller("SearchCtrl",["$scope","$http",function(a,b){a.submit=function(){b.post("/api/feeds/init",a.search).success(function(a){console.log(a)})}}]),angular.module("podcaddyApp").controller("AllfeedsCtrl",["$scope","$rootScope","$http","$location","LazyLoad","Timer",function(a,b,c,d,e,f){b.cssPage="allfeedsPage",f.stop(),c.post("/api/feeds/all").success(function(b){a.lazyLoad=new e(b)}),a.initFeeds=function(){a.fetchingFeeds=!0,c.post("api/feeds/init").success(function(){})}}]),angular.module("podcaddyApp").directive("allfeedsitem",["$http","LazyLoad",function(a,b){return{templateUrl:"/views/allfeedsitem.html",restrict:"AE",scope:{feed:"="},replace:!0,link:function(c,d){var e=$(d),f=!1;c.$watch("feed.w",function(a){a&&(f=b.checkScroll(a,e,c.feed.data.image,c.feed.id,f))},!0),c.toggle=function(){c.toggling=!0,a.post("/api/subs/toggle",{feedid:c.feed.id}).success(function(a){c.toggling=!1,c.feed.subscribed=a.subscribed?[!0]:[]})}}}}]),angular.module("podcaddyApp").directive("audioitem",["PagePlayer","$http","$timeout","LazyLoad",function(a,b,c,d){return{restrict:"AE",templateUrl:"/views/audioitem.html",replace:!0,scope:{item:"="},link:function(e,f){var g=function(a){var b=0;if(a.offsetParent)for(;a.offsetParent;)b+=a.offsetLeft,a=a.offsetParent;else a.x&&(b+=a.x);return b};f.bind("click",function(b){if(-1!==["position","loading","statusbar"].indexOf(b.target.className)){for(var c=b.target;"statusbar"!==c.className;)c=c.parentNode;a.setPosition((b.clientX-g(c))/c.offsetWidth)}else"A"===b.target.tagName||"A"===b.target.parentNode.tagName||a.togglePlay(e.item)}),f.bind("mouseover",function(a){-1===["position","loading","statusbar"].indexOf(a.target.className)&&"A"!==a.target.tagName&&"A"!==a.target.parentNode.tagName&&f.addClass("hover")}),f.bind("mouseout",function(){f.removeClass("hover")}),a.lastSound&&a.lastSound.id==="item_"+e.item.id&&(f.addClass(1===a.lastSound.playState?"playing":"paused"),a.updatePosition());var h=$(f.find(".thumbnail")),i=!1;e.$watch("item.w",function(a){a&&(i=d.checkScroll(a,h,e.item.data.image,e.item.feedId,i))},!0),e.skip=function(c){b.post("/api/skip",{id:c.id}).success(function(){a.fetchData()})},e.toggleSub=function(d){b.post("/api/subs/toggle",{feedid:d}).success(function(){e.toggling=!1,c(function(){a.fetchData()},100)})}}}}]),angular.module("podcaddyApp").controller("NavCtrl",["$scope","NavService","$location","$http","$rootScope","$timeout",function(a,b,c,d,e,f){function g(){d.post("/api/subs/all").success(function(a){console.log(a)})}a.nav=b,a.go=b.go,a.filter=b.filter,a.submit=function(){return"http://addall"===a.search.url?g():void d.post("/api/feeds/add",{url:a.search.url}).success(function(b){a.search.url="",f(function(){b.error?e.modalFeed={message:"There was an error",error:!0,description:"We couldn't read that feed, it was too funky"}:(b.message="You have added a podcast!",e.modalFeed=b),$(".md-modal").addClass("md-show")})})}}]),angular.module("podcaddyApp").factory("NavService",["$route","$rootScope","$location",function(a,b,c){function d(a){if(a)switch(0===a.indexOf("feed-")&&(e.feed=a.replace(/feed-/,"")),0===a.indexOf("playlist-")&&(e.playlist=a.replace(/playlist-/,"")),a){case"day":e.period="day";break;case"week":e.period="week";break;case"month":e.period="month";break;case"year":e.period="year";break;case"alltime":e.period="alltime";break;case"visited":e.visited="visited";break;case"unvisited":e.visited="unvisited";break;case"all":e.visited="all";break;case"desc":e.direction="desc";break;case"asc":e.direction="asc"}}var e={page:"/",period:"week",visited:"unvisited",direction:"desc",feed:"all",playlist:"none"};return{pageList:[{value:"/",text:"Home",action:"go()"},{value:"/myfeeds",text:"My feeds",action:"go()"},{value:"/allfeeds",text:"Directory",action:"go()"}],periodList:[{value:"day",text:"Day",action:"filter()"},{value:"week",text:"Week",action:"filter()"},{value:"month",text:"Month",action:"filter()"},{value:"year",text:"Year",action:"filter()"},{value:"alltime",text:"All Time",action:"filter()"}],visitedList:[{value:"unvisited",text:"New",action:"filter()"},{value:"visited",text:"Old",action:"filter()"},{value:"all",text:"All",action:"filter()"}],dirList:[{value:"desc",text:"Newest first",action:"filter()"},{value:"asc",text:"Oldest first",action:"filter()"}],filters:e,filter:function(){var a=("all"===e.feed?"":"/feed-"+e.feed)+("none"===e.playlist?"":"/playlist-"+e.playlist)+("week"===e.period?"":"/"+e.period)+("unvisited"===e.visited?"":"/"+e.visited)+("desc"===e.direction?"":"/"+e.direction);c.path(a)},go:function(){c.path(e.page)},parseArg:d}}]),angular.module("podcaddyApp").directive("dropdown",function(){return{restrict:"A",require:"ngModel",scope:{list:"=dropdown",ngModel:"="},template:'<div class="dropdown" ng-click="open=!open" ng-class="{open:open}"><div ng-repeat="thing in list" style="top: {{($index + 1) * height}}px; -webkit-transition-delay: {{(list.length - $index) * 0.03}}s; z-index: {{list.length - $index}}" ng-hide="!open" ng-click="update(thing)" ng-class="{selected:selected===thing}"><span ng-bind-html="thing.text" class="item"></span></div><span class="title" style="top: 0px; z-index: {{list.length + 1}}"><span ng-bind-html="selected.text" class="item"></span></span><span class="clickscreen" ng-hide="!open">&nbsp;</span></div>',replace:!0,link:function(a,b,c,d){a.height=b[0].offsetHeight,a.$watch("ngModel",function(){angular.forEach(a.list,function(b){d.$modelValue===b.value&&(a.selected=b)})}),a.update=function(b){d.$setViewValue(b.value),d.$render(),b.action&&a.$parent.$eval(b.action)}}}}),angular.module("podcaddyApp").factory("PagePlayer",["NavService","$http","$timeout","$rootScope","$window","LazyLoad",function(a,b,c,d,e,f){function g(){var e=soundManager,g=navigator.userAgent,h=g.match(/ipad|ipod|iphone/i);this.init=function(){e.useFlashBlock=!0},this.getTime=function(a,b){var c=Math.floor(a/1e3),d=Math.floor(c/60),e=c-60*d;return b?d+":"+(10>e?"0"+e:e):{min:d,sec:e}},this.setPosition=function(a){var b=i.lastSound,c=Math.floor(a*i.getDurationEstimate(b));isNaN(c)||(c=Math.min(c,b.duration)),isNaN(c)||b.setPosition(c),b.resume()},this.events={play:function(){$(".playing").removeClass("playing"),$("#"+i.lastSound.id+", .now-playing").addClass("playing")},stop:function(){$(".playing").removeClass("playing")},pause:function(){$(".playing").removeClass("playing").addClass("paused")},resume:function(){$(".playing").removeClass("playing"),$(".paused").removeClass("paused").addClass("playing")},finish:function(){$(".playing").removeClass("playing"),i.skip(i.lastSound.id)},whileloading:function(){$(".playing .loading, .paused .loading").css("width",this.bytesLoaded/this.bytesTotal*100+"%")},onload:function(){},whileplaying:function(){i.updateTime(),i.updatePosition(),j()},error:function(a){console.log(a)}},this.updateTime=function(){$(".playing .sm2_position").text(i.getTime(i.lastSound.position,!0)),$(".playing .sm2_total").text(i.getTime(i.getDurationEstimate(i.lastSound),!0))},this.updatePosition=function(){$(".playing .position").css("width",i.lastSound.position/i.getDurationEstimate(i.lastSound)*100+"%")},this.getDurationEstimate=function(a){return a.instanceOptions.isMovieStar?a.duration:a.durationEstimate||0},this.skip=function(a){c(function(){$("#"+a).next().find(".podimg").click()})},this.togglePlay=function(a){if(i.lastSound&&i.lastSound.id==="item_"+a.id)2!==i.lastSound.readyState&&(1!==i.lastSound.playState?i.lastSound.play():i.lastSound.togglePause());else{i.lastSound&&(e.stop(i.lastSound.id),h||e.unload(i.lastSound.id));var b=e.createSound({id:"item_"+a.id,url:decodeURI(a.url),onplay:i.events.play,onstop:i.events.stop,onpause:i.events.pause,onresume:i.events.resume,onfinish:i.events.finish,whileplaying:i.events.whileplaying,whileloading:i.events.whileloading,onerror:i.events.error});i.lastSound=b,b.play(),d.currentitem=a}},d.lazyLoad=new f([]),this.fetchData=function(){b.get("/api/subscribed/"+a.filters.feed+"/"+a.filters.playlist+"/"+a.filters.period+"/"+a.filters.visited+"/"+a.filters.direction).success(function(a,b){if(200===b){var e=!1;if(a.items.length!==d.lazyLoad.items.length)e=!0;else for(var f=0;f<a.items.length;f++)if(a.items[f].id!==d.lazyLoad.items[f].id){e=!0;break}e&&(d.lazyLoad.reinit(a.items),i.lastSound&&c(function(){$("#"+i.lastSound.id).addClass(1===i.lastSound.playState?"playing":"paused"),i.updateTime(),i.updatePosition()}))}})};var i=this}function h(a){return a.target||(e.event?e.event.srcElement:null)}var i,j=_.throttle(function(){b.post("/api/position",{itemid:i.lastSound.id.replace(/[a-z_]+/,""),position:i.lastSound.position,history:i.lastSound.position>i.lastSound.duration/10})},3e4);return e.addEventListener("mousedown",function(a){var b=$(h(a));b.is(".statusbar, .position, .loading")&&i.setPosition(a)}),soundManager.useFlashBlock=!0,soundManager.onready(function(){i=new g,i.init(),i.fetchData()}),{changePage:function(){i&&i.fetchData()},fetchData:function(){i.fetchData()},togglePlay:function(a){i.togglePlay(a)},skip:function(a){i.skip("item_"+a.id)},setPosition:function(a){i.setPosition(a)}}}]),angular.module("podcaddyApp").controller("MyfeedsCtrl",["$scope","$http","Timer",function(a,b,c){c.stop(),b.post("/api/feeds/subs").success(function(b){a.feeds=b})}]),angular.module("podcaddyApp").directive("myfeedsitem",["$http","LazyLoad",function(a,b){return{templateUrl:"/views/myfeedsitem.html",restrict:"AE",scope:{feed:"="},replace:!0,link:function(c,d){var e=$(d),f=!1;c.$watch("feed.w",function(a){a&&(f=b.checkScroll(a,e,c.feed.data.image,c.feed.id,f))},!0),c.toggle=function(){c.toggling=!0,a.post("/api/subs/toggle",{feedid:c.feed.id}).success(function(a){c.toggling=!1,c.feed.subscribed=a.subscribed?[!0]:[]})}}}}]),angular.module("podcaddyApp").factory("LazyLoad",["$window","$timeout",function(a,b){var c=function(c){var d=this;this.items=c;var e=$(a);this.doScroll=function(){b(function(){_.each(d.items,function(a){a.w={scrollTop:e.scrollTop(),height:e.height(),rnd:Math.random()}})})},this.reinit=function(a){b(function(){d.items=a,d.doScroll()})},d.doScroll(),e.scroll(d.doScroll),e.resize(d.doScroll)};return c.checkScroll=function(a,b,c,d,e){var f=100,g=a.scrollTop,h=g+a.height,i=b.offset().top,j=i+b.height();return j>=g-f&&h+f>=i?(b.hasClass("hidden")&&b.removeClass("hidden"),e||($("<img/>").attr("src",c).load(function(){b.css("background-image","url("+c+")")}).error(function(){$(this).remove(),b.css("background-image","url(http://unsplash.it/200/200?image="+d+")")}),c||b.css("background-image","url(http://unsplash.it/200/200?image="+d+")"),e=!0)):b.addClass("hidden"),e},c}]),angular.module("podcaddyApp").factory("Timer",["$interval","PagePlayer",function(a,b){var c,d=function(){c=a(function(){b.fetchData()},3e5)},e=function(){angular.isDefined(c)&&a.cancel(c)};return{start:d,stop:e}}]),angular.module("podcaddyApp").directive("modalAddFeed",["$http","$rootScope",function(a,b){return{templateUrl:"/views/modaladdfeed.html",restrict:"E",scope:{feed:"="},link:function(c,d){c.close=function(){d.find(".md-modal").removeClass("md-show")},c.toggle=function(){c.toggling=!0,a.post("/api/subs/toggle",{feedid:c.feed.id}).success(function(){c.toggling=!1,c.close(),b.pagePlayer.fetchData()})}}}}]),angular.module("podcaddyApp").directive("nowPlaying",["PagePlayer",function(a){return{templateUrl:"/views/nowplaying.html",restrict:"E",replace:!0,link:function(b){b.togglePlay=function(b){a.togglePlay(b)},b.skip=function(b){a.skip(b)}}}}]),angular.module("podcaddyApp").filter("widow",function(){return function(a){return a.replace(/\s(\S+)$/,"&nbsp;$1")}});